name: "Validate Kalium References"

on:
  pull_request:
    types: [ opened, synchronize ] # Don't rerun on `edited` to save time
    paths:
      - 'kalium'

jobs:
  validate-kalium-ref:
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive # Needed in order to fetch Kalium sources for building
          fetch-depth: 0

      - name: Run git merge-base
        id: validate_kalium
        env:
          GH_BASE_REF: ${{github.base_ref}}
        continue-on-error: true
        run: |
          KALIUM_TO_REF="$(git rev-parse HEAD:kalium)"
          git fetch
          git checkout $GH_BASE_REF
          git pull
          git submodule update
          KALIUM_FROM_REF=$(git rev-parse HEAD:kalium)"
          echo "::set-output name=kalium_from::$($KALIUM_FROM_REF)"
          echo "::set-output name=kalium_to::$($KALIUM_TO_REF)"
          echo "::set-output name=is_kalium_rollback::$(
            cd kalium
            git --merge-base $KALIUM_FROM_REF $KALIUM_TO_REF
          )"
          unset KALIUM_TO_REF
          unset KALIUM_FROM_REF

      - name: Leave a comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
        if: ${{ steps.validate_kalium.outputs.is_kalium_rollback == 0 }} # The first commit is NOT an ancestor of the second one
        run: |
          echo "is_kalium_rollback: ${{ steps.validate_kalium.outputs.is_kalium_rollback }}"
          gh pr comment "${{github.head_ref}}" --body "@$PR_AUTHOR looks like you are rolling back kalium to a previous commitish.

          From: [${{steps.validate_kalium.outputs.kalium_from}}](https://github.com/wireapp/kalium/tree/${{steps.validate_kalium.outputs.kalium_from}})
          ⬇️
          To: [${{steps.validate_kalium.outputs.kalium_to}}](https://github.com/wireapp/kalium/tree/${{steps.validate_kalium.outputs.kalium_to}})

          Is this intentional?"
