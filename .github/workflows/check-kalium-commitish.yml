name: "Validate Kalium References"

on:
  pull_request:
    types: [ opened, synchronize ] # Don't rerun on `edited` to save time
    paths:
      - 'kalium'

jobs:
  validate-kalium-ref:
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive # Needed in order to fetch Kalium sources for building
          fetch-depth: 0

      - name: Run git merge-base
        id: validate_kalium
        run: |
          git fetch
          git checkout ${{github.base_ref}}
          git pull
          git submodule update
          git checkout ${GITHUB_REF#refs\/*}
          git submodule update
          echo "::set-output name=kalium_from_to::$(
            git diff --merge-base ${{github.base_ref}} kalium |
            awk '/^i/{c=NR}NR>c+2&&/^[-+]/' |
            awk '{split($0,words," "); print words[3];}' |
            tr '\n' ' '
          )"
          echo "::set-output name=is_kalium_rollback::$(
            git diff --merge-base ${{github.base_ref}} kalium |
            awk '/^i/{c=NR}NR>c+2&&/^[-+]/' |
            awk '{split($0,words," "); print words[3];}' |
            xargs git -C kalium merge-base --is-ancestor
          )"

      - name: Leave a comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        if: ${{ steps.validate_kalium.outputs.is_kalium_rollback != 0 }}
        run: |
          gh pr comment "${{github.head_ref}}" --body "@${{github.event.pull_request.user.login}} looks like you are rolling back kalium to a previous commitish.\n\nCommitish change: `${{steps.validate_kalium.outputs.kalium_from_to}}`\n\nIs this intentional?"