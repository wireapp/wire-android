name: QA Android UI Tests

# Concurrency lock:
# - If androidDeviceId is set, we lock per-device so only one run can use that specific phone at a time (other devices can run in parallel).
# - If androidDeviceId is empty ("auto"), we lock the shared device pool so only one auto-run uses the farm at a time (other auto-runs queue).
concurrency:
  group: qa-android-ui-tests-office-${{ inputs.androidDeviceId || 'auto' }}
  cancel-in-progress: false

on:
  workflow_dispatch:
    inputs:
      appBuildNumber:
        description: "AppBuildNumber. Use 'latest' or build number(e.g 71389)"
        required: true
        default: "latest"
        type: string

      isUpgrade:
        description: "Upgrade test? If true, oldBuildNumber is REQUIRED."
        required: true
        default: false
        type: boolean

      oldBuildNumber:
        description: "For upgrade runs: type the old build number here"
        required: false
        default: ""
        type: string

      enforceAppInstall:
        description: "If you want to run with a lower version than currently on the device, set this value to true."
        required: true
        default: false
        type: boolean

      flavor:
        description: "App flavor."
        required: true
        type: choice
        options:
          - internal release candidate
          - internal beta
          - staging compat
          - experimental
          - column-1
          - column-2
          - column-3
          - debug
          - fdroid
          - production
        default: internal release candidate

      TAGS:
        description: "Tags: '@regression' OR '@TC-8143'."
        required: false
        default: ""
        type: string

      testinyRunName:
        description: "TESTINY_RUN_NAME."
        required: false
        default: ""
        type: string

      androidDeviceId:
        description: "androidDeviceId. Target a specific device. Leave empty for auto."
        required: false
        default: ""
        type: string

permissions:
  contents: read

jobs:
  # Validate user inputs and derive selectors.
  validate-and-resolve-inputs:
    name: Validate + resolve selectors
    runs-on: ubuntu-latest

    outputs:
      resolvedTestCaseId: ${{ steps.resolve_selector.outputs.testCaseId }}
      resolvedCategory: ${{ steps.resolve_selector.outputs.category }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Validate upgrade inputs before runner work starts.
      - name: Validate upgrade inputs
        shell: bash
        env:
          IS_UPGRADE: ${{ inputs.isUpgrade }}
          OLD_BUILD_NUMBER: ${{ inputs.oldBuildNumber }}
        run: bash scripts/qa_android_ui_tests/validation.sh validate-upgrade-inputs

      # Resolve TAGS into CI selectors and expose them as job outputs.
      - name: Resolve selector from TAGS
        id: resolve_selector
        shell: bash
        env:
          TAGS_RAW: ${{ inputs.TAGS }}
        run: bash scripts/qa_android_ui_tests/validation.sh resolve-selector-from-tags

      # Print resolved values for traceability in workflow logs.
      - name: Print resolved values
        shell: bash
        env:
          FLAVOR_INPUT: ${{ inputs.flavor }}
          RESOLVED_TESTCASE_ID: ${{ steps.resolve_selector.outputs.testCaseId }}
          RESOLVED_CATEGORY: ${{ steps.resolve_selector.outputs.category }}
        run: bash scripts/qa_android_ui_tests/validation.sh print-resolved-values

  run-android-ui-tests:
    name: Run Android UI tests
    runs-on:
      - self-hosted
      - Linux
      - X64
      - office
      - android-qa

    needs: validate-and-resolve-inputs
    permissions:
      contents: write

    env:
      AWS_REGION: eu-west-1
      S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
      OP_VAULT: "Test Automation"
      FLAVORS_CONFIG_PATH: "/etc/android-qa/flavors.json"

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          clean: true
          submodules: recursive

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Set up Android SDK (ANDROID_HOME + adb)
        uses: android-actions/setup-android@v3

      # Verify required CLIs on the runner before setup continues.
      - name: Ensure required tools exist
        run: bash scripts/qa_android_ui_tests/execution_setup.sh ensure-required-tools

      # Flavor resolution is runner-driven (from /etc/android-qa/flavors.json), not hardcoded in repo.
      # This bash subcommand exports S3_FOLDER, APP_ID, and PACKAGES_TO_UNINSTALL for downstream steps.
      - name: Resolve flavor (runner config)
        id: resolve_flavor
        env:
          FLAVOR_INPUT: ${{ inputs.flavor }}
        run: bash scripts/qa_android_ui_tests/execution_setup.sh resolve-flavor

      - name: Configure AWS credentials (for S3)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1

      # Download app APK(s) from S3 and export resolved build metadata.
      - name: Download APK(s) from S3
        id: download_apks
        env:
          APP_BUILD_NUMBER: ${{ inputs.appBuildNumber }}
          IS_UPGRADE: ${{ inputs.isUpgrade }}
          OLD_BUILD_NUMBER: ${{ inputs.oldBuildNumber }}
        run: bash scripts/qa_android_ui_tests/execution_setup.sh download-apks

      # Select device(s): use input device when provided, otherwise auto-pick.
      - name: Detect target device(s)
        env:
          TARGET_DEVICE_ID: ${{ inputs.androidDeviceId }}
          RESOLVED_TESTCASE_ID: ${{ needs.validate-and-resolve-inputs.outputs.resolvedTestCaseId }}
        run: bash scripts/qa_android_ui_tests/execution_setup.sh detect-target-devices

      # Install app/test prerequisites on each selected device.
      - name: Install APK(s) on device(s)
        env:
          ENFORCE_APP_INSTALL: ${{ inputs.enforceAppInstall }}
          IS_UPGRADE: ${{ inputs.isUpgrade }}
        run: bash scripts/qa_android_ui_tests/execution_setup.sh install-apks-on-devices

      - name: Install 1Password CLI
        uses: 1password/install-cli-action@v2

      # Fetch runtime secrets only for this run.
      - name: Fetch secrets.json (runtime only)
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
        run: bash scripts/qa_android_ui_tests/execution_setup.sh fetch-runtime-secrets

      # Build androidTest APK once and reuse it across selected devices.
      - name: Build test APK (assemble once)
        run: bash scripts/qa_android_ui_tests/execution_setup.sh build-test-apk

      # Resolve the built androidTest APK path for execution steps.
      - name: Resolve test APK path
        run: bash scripts/qa_android_ui_tests/execution_setup.sh resolve-test-apk-path

      # Resolve AndroidX Test Services APKs required for TestStorage/Allure.
      - name: Resolve AndroidX Test Services APKs (for Allure TestStorage)
        run: bash scripts/qa_android_ui_tests/execution_setup.sh resolve-test-services-apks

      # Run instrumentation on selected devices and stream per-device logs.
      - name: Run UI tests (one shard per device, adb instrumentation)
        env:
          RESOLVED_TESTCASE_ID: ${{ needs.validate-and-resolve-inputs.outputs.resolvedTestCaseId }}
          RESOLVED_CATEGORY: ${{ needs.validate-and-resolve-inputs.outputs.resolvedCategory }}
          IS_UPGRADE: ${{ inputs.isUpgrade }}
        run: bash scripts/qa_android_ui_tests/run_ui_tests.sh

      # Remove runtime secrets before report generation and publish steps.
      - name: Remove runtime secrets (before Allure/Pages)
        if: always()
        run: bash scripts/qa_android_ui_tests/reporting.sh remove-runtime-secrets

      # Pull raw allure-results from each device even when tests fail.
      - name: Pull Allure results from device(s)
        if: always()
        env:
          OUT_DIR: ${{ runner.temp }}/allure-results
        run: bash scripts/qa_android_ui_tests/reporting.sh pull-allure-results

      # Merge per-device results and attach run metadata labels.
      - name: Merge Allure results (add device label)
        if: always()
        env:
          OUT_DIR: ${{ runner.temp }}/allure-results
          MERGED_DIR: ${{ runner.temp }}/allure-results-merged
          REAL_BUILD_NUMBER: ${{ env.REAL_BUILD_NUMBER }}
          NEW_APK_NAME: ${{ env.NEW_APK_NAME }}
          INPUT_TAGS: ${{ inputs.TAGS }}
        run: bash scripts/qa_android_ui_tests/reporting.sh merge-allure-results

      # Generate static Allure HTML from merged results.
      - name: Generate Allure HTML report
        if: always()
        env:
          MERGED_DIR: ${{ runner.temp }}/allure-results-merged
          REPORT_DIR: ${{ runner.temp }}/allure-report
        run: bash scripts/qa_android_ui_tests/reporting.sh generate-allure-report

      - name: Checkout GitHub Pages branch
        if: always()
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 1
          persist-credentials: true

      # Publish report snapshots and apply retention cleanup.
      - name: Publish Allure report to Pages branch
        if: always()
        env:
          REPORT_DIR: ${{ runner.temp }}/allure-report
          PAGES_DIR: gh-pages/docs/qa-ui-tests
          KEEP_DAYS: "90"
          INPUT_TAGS: ${{ inputs.TAGS }}
          APK_VERSION: ${{ env.REAL_BUILD_NUMBER }}
          APK_NAME: ${{ env.NEW_APK_NAME }}
        run: bash scripts/qa_android_ui_tests/reporting.sh publish-allure-report

      # Clean temporary artifacts on the runner, even after failures.
      - name: Cleanup (remove secrets + build outputs)
        if: always()
        env:
          ALLURE_RESULTS_DIR: ${{ runner.temp }}/allure-results
          ALLURE_RESULTS_MERGED_DIR: ${{ runner.temp }}/allure-results-merged
          ALLURE_REPORT_DIR: ${{ runner.temp }}/allure-report
        run: bash scripts/qa_android_ui_tests/reporting.sh cleanup-workspace
