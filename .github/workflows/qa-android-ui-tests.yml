name: QA Android UI Tests

on:
  workflow_dispatch:
    inputs:
      appBuildNumber:
        description: "AppBuildNumber. Use 'latest' or build number(e.g 71389)"
        required: true
        default: "latest"
        type: string

      isUpgrade:
        description: "Upgrade test? If true, oldBuildNumber is REQUIRED."
        required: true
        default: false
        type: boolean

      oldBuildNumber:
        description: "For upgrade runs: type the old build number here"
        required: false
        default: ""
        type: string

      enforceAppInstall:
        description: "If you want to run with a lower version than currently on the device, set this value to true."
        required: true
        default: false
        type: boolean

      flavor:
        description: "App flavor."
        required: true
        type: choice
        options:
          - internal release candidate
          - internal beta
          - staging compat
          - experimental
          - column-1
          - column-2
          - column-3
          - debug
          - fdroid
          - production
        default: internal release candidate

      TAGS:
        description: "Tags: '@regression' OR '@TC-8143'."
        required: false
        default: ""
        type: string

      testinyRunName:
        description: "TESTINY_RUN_NAME."
        required: false
        default: ""
        type: string

      androidDeviceId:
        description: "androidDeviceId. Target a specific device. Leave empty for auto."
        required: false
        default: ""
        type: string

permissions:
  contents: read

jobs:
  # Validate user inputs and derive selectors and flavor metadata.
  validate-and-resolve-inputs:
    name: Validate + resolve selectors
    runs-on: ubuntu-latest

    outputs:
      resolvedTestCaseId: ${{ steps.resolve_selector.outputs.testCaseId }}
      resolvedCategory: ${{ steps.resolve_selector.outputs.category }}
      s3Folder: ${{ steps.resolve_flavor.outputs.s3Folder }}
      appId: ${{ steps.resolve_flavor.outputs.appId }}

    steps:
      # Validate upgrade inputs for consistency.
      - name: Validate upgrade inputs
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ inputs.isUpgrade }}" == "true" && -z "${{ inputs.oldBuildNumber }}" ]]; then
            echo "ERROR: oldBuildNumber is REQUIRED when isUpgrade=true"
            exit 1
          fi

      # Parse TAGS into a single selector (testCaseId or category).
      - name: Resolve selector from TAGS
        id: resolve_selector
        shell: bash
        run: |
          set -euo pipefail

          TESTCASE_ID=""
          CATEGORY=""
          TAGS_RAW="${{ inputs.TAGS }}"

          trim() { echo "$1" | xargs; }

          if [[ -n "$(trim "${TAGS_RAW}")" ]]; then
            sel=""
            IFS=',' read -ra parts <<< "${TAGS_RAW}"
            for p in "${parts[@]}"; do
              t="$(trim "$p")"
              if [[ -n "$t" ]]; then
                sel="$t"
                break
              fi
            done

            sel="${sel#@}"
            sel="$(trim "$sel")"

            if [[ "$sel" == *:* ]]; then
              echo "ERROR: TAGS format '@key:value' is not supported yet. Use '@TC-1234' or '@category'."
              exit 1
            fi

            if [[ "$sel" =~ ^TC-[0-9]+$ ]]; then
              TESTCASE_ID="$sel"
            else
              CATEGORY="$sel"
            fi
          fi

          echo "testCaseId=$TESTCASE_ID" >> "$GITHUB_OUTPUT"
          echo "category=$CATEGORY" >> "$GITHUB_OUTPUT"

      # Map flavor to S3 path and Android package id.
      - name: Resolve flavor -> S3_FOLDER + APP_ID
        id: resolve_flavor
        shell: bash
        run: |
          set -euo pipefail

          FLAVOR="$(echo "${{ inputs.flavor }}" | xargs)"
          S3_FOLDER=""
          APP_ID=""

          case "$FLAVOR" in
            "staging compat")
              S3_FOLDER="artifacts/megazord/android/reloaded/staging/compat/"
              APP_ID="com.waz.zclient.dev"
              ;;
            "internal beta")
              S3_FOLDER="artifacts/megazord/android/reloaded/beta/release/"
              APP_ID="com.wire.android.internal"
              ;;
            "internal release candidate")
              S3_FOLDER="artifacts/megazord/android/reloaded/internal/compat/"
              APP_ID="com.wire.internal"
              ;;
            "experimental")
              S3_FOLDER="artifacts/megazord/android/reloaded/staging/compat/"
              APP_ID="com.waz.zclient.dev"
              ;;
            "column-1")
              S3_FOLDER="android/custom/bund/column1/prod/compatrelease/"
              APP_ID="com.wire.android.bund"
              ;;
            "column-2")
              S3_FOLDER="android/custom/bund/column2/prod/compatrelease/"
              APP_ID="com.wire.android.bund.column2"
              ;;
            "column-3")
              S3_FOLDER="android/custom/bund/column3/prod/compatrelease/"
              APP_ID="com.wire.android.bund.column3"
              ;;
            "debug")
              S3_FOLDER="artifacts/megazord/android/reloaded/dev/debug/"
              APP_ID="com.waz.zclient.dev.debug"
              ;;
            "fdroid")
              S3_FOLDER="artifacts/megazord/android/reloaded/fdroid/compatrelease/"
              APP_ID="com.wire"
              ;;
            "production")
              S3_FOLDER="artifacts/megazord/android/reloaded/prod/compatrelease/"
              APP_ID="com.wire"
              ;;
            *)
              echo "ERROR: Unknown flavor: '$FLAVOR'"
              exit 1
              ;;
          esac

          echo "s3Folder=$S3_FOLDER" >> "$GITHUB_OUTPUT"
          echo "appId=$APP_ID" >> "$GITHUB_OUTPUT"

      # Log resolved values for troubleshooting.
      - name: Print resolved values
        shell: bash
        run: |
          set -euo pipefail
          echo "flavor=${{ inputs.flavor }}"
          echo "resolvedTestCaseId=${{ steps.resolve_selector.outputs.testCaseId }}"
          echo "resolvedCategory=${{ steps.resolve_selector.outputs.category }}"

