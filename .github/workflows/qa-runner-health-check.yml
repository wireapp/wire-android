name: QA Runner Health Check

on:
  workflow_dispatch:

jobs:
  health-check:
    runs-on:
      - self-hosted
      - Linux
      - X64
      - office

    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: buildjet/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Setup ADB (no sudo)
        run: |
          set -e

          if command -v adb >/dev/null 2>&1; then
            echo "adb already available"
            adb version
          else
            echo "Downloading Android platform-tools..."
            cd "$HOME"
            curl -L -o platform-tools.zip https://dl.google.com/android/repository/platform-tools-latest-linux.zip
            unzip -oq platform-tools.zip
            echo "$HOME/platform-tools" >> "$GITHUB_PATH"
            adb version
          fi

      - name: Check connected Android devices
        run: |
          set -e
          adb start-server

          echo "=== adb devices -l ==="
          adb devices -l || true

          COUNT=$(adb devices | awk 'NR>1 && $2=="device"{print $1}' | wc -l | tr -d ' ')
          echo "Authorized devices detected: $COUNT"

          if [ "$COUNT" -eq 0 ]; then
            echo "ERROR: No authorized Android devices detected."
            echo "Common causes:"
            echo "- No phone connected to the runner USB hub"
            echo "- Phone is 'unauthorized' (unlock and accept USB debugging prompt)"
            echo "- USB mode/cable issue"
            exit 1
          fi
