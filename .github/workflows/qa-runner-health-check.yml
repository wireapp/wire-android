name: QA Runner Health Check

on:
  workflow_dispatch:

jobs:
  health-check:
    runs-on:
      - self-hosted
      - Linux
      - X64
      - office

    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: buildjet/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Setup ADB (no sudo)
        shell: bash
        run: |
          set -euo pipefail

          if command -v adb >/dev/null 2>&1; then
            echo "adb already available: $(command -v adb)"
            adb version
            exit 0
          fi

          TOOLS_DIR="$HOME/android-platform-tools"
          ADB_DIR="$TOOLS_DIR/platform-tools"
          ADB_BIN="$ADB_DIR/adb"

          echo "Downloading Android platform-tools to $TOOLS_DIR"
          mkdir -p "$TOOLS_DIR"
          cd "$TOOLS_DIR"

          curl -fsSL -o platform-tools.zip https://dl.google.com/android/repository/platform-tools-latest-linux.zip
          unzip -oq platform-tools.zip

          # Make sure adb exists where we expect it
          if [ ! -x "$ADB_BIN" ]; then
            echo "ERROR: adb not found at $ADB_BIN"
            echo "Contents of $TOOLS_DIR:"
            ls -la "$TOOLS_DIR" || true
            echo "Contents of $ADB_DIR:"
            ls -la "$ADB_DIR" || true
            exit 1
          fi

          # Add to PATH for subsequent steps
          echo "$ADB_DIR" >> "$GITHUB_PATH"

          # Verify in THIS step using full path (PATH update may not apply yet)
          "$ADB_BIN" version

      - name: Check connected Android devices
        shell: bash
        run: |
          set -euo pipefail

          adb version
          adb start-server
          adb devices -l

          COUNT=$(adb devices | awk 'NR>1 && $2=="device"{print $1}' | wc -l | tr -d ' ')
          echo "Authorized devices detected: $COUNT"

          if [ "$COUNT" -eq 0 ]; then
            echo "ERROR: No authorized Android devices detected."
            echo "Common causes:"
            echo "- No phone connected to the runner USB hub"
            echo "- Phone is 'unauthorized' (unlock and accept USB debugging prompt)"
            echo "- USB mode/cable issue"
            exit 1
          fi
