name: "Checks"

on:
  workflow_call:
    outputs:
      quality-passed:
        description: "Quality gates status"
        value: ${{ jobs.validate.outputs.result }}

concurrency:
  group: quality-gates-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code-analysis:
    name: "Code Analysis"
    uses: ./.github/workflows/code-analysis.yml

  ui-tests:
    name: "UI Tests"
    uses: ./.github/workflows/gradle-run-ui-tests.yml

  unit-tests:
    name: "Unit Tests & Coverage"
    uses: ./.github/workflows/gradle-run-unit-tests.yml
    secrets: inherit

  validate:
    name: "Validate Quality Gates"
    needs: [code-analysis, ui-tests, unit-tests]
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.result.outputs.status }}
    steps:
      - name: Check quality gate results
        id: result
        run: |
          echo "## Quality Gates Summary" >> $GITHUB_STEP_SUMMARY
          echo "✅ Code Analysis: Passed" >> $GITHUB_STEP_SUMMARY
          echo "✅ UI Tests: Passed" >> $GITHUB_STEP_SUMMARY  
          echo "✅ Unit Tests & Coverage: Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🎉 All quality gates passed! Proceeding with builds..." >> $GITHUB_STEP_SUMMARY
          
          echo "All quality gates passed successfully"
          echo "status=success" >> $GITHUB_OUTPUT
          
      - name: Quality gates failed
        if: failure()
        run: |
          echo "## Quality Gates Summary" >> $GITHUB_STEP_SUMMARY
          echo "❌ One or more quality gates failed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "🚫 Builds will not proceed until all quality gates pass." >> $GITHUB_STEP_SUMMARY
          
          echo "Quality gates failed - builds will not proceed"
          exit 1
