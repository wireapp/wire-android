name: "Rebase main"

on:
  workflow_dispatch:
    inputs:
      rebase-answer:
        description: 'Are you sure you want to rebase main? [y/N] '
        required: true
  workflow_call:
    inputs:
      rebase-answer:
        required: true
        type: string

jobs:
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    SLACK_WEBHOOK_URL: ${{ secrets.WIRE_ANDROID_TEAM_WEBHOOK_URL }}
  run-unit-tests:
    uses: ./.github/workflows/gradle-run-unit-tests.yml
    if: ${{ github.ref }} == 'refs/heads/main' && ${{ github.event.inputs.rebase-answer }} == 'y'
  run-ui-tests:
    uses: ./.github/workflows/gradle-run-ui-tests.yml
    if: ${{ github.ref }} == 'refs/heads/main' && ${{ github.event.inputs.rebase-answer }} == 'y'
  rebase-main:
    runs-on: ubuntu-latest
    needs: [run-unit-tests, run-ui-tests]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive # Needed in order to fetch Kalium sources for building
          fetch-depth: 0
      - name: Rebase develop onto main
        if: ${{ github.ref }} == 'refs/heads/main' && ${{ github.event.inputs.rebase-answer }} == 'y'
        run: |
          git rebase develop --strategy recursive -Xours
      - name: Push changes
        if: ${{ github.ref }} == 'refs/heads/main' && ${{ github.event.inputs.rebase-answer }} == 'y'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
      - name: Notify on Wire
        uses: 8398a7/action-slack@v3
        if: ${{ github.ref }} == 'refs/heads/main' && ${{ github.event.inputs.rebase-answer }} == 'y'
        with:
          status: ${{ job.status }}
          text: "Rebased `main` onto `develop` - Playstore build triggered ðŸš€"