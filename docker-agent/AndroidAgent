# Android Agent Docker Image
#
# Base: Ubuntu 24.04 (noble) with glibc 2.39
# Required for core-crypto native binaries which need glibc 2.38+
#
# Build:
#   docker build -t android-agent:latest .
#
# Test:
#   docker run --rm android-agent:latest ldd --version | head -1
#   # Should show: GLIBC 2.39

FROM eclipse-temurin:17-jdk-noble

RUN apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    apt-get update && \
    apt-get install -yq \
        unzip \
        libc6 \
        libstdc++6 \
        zlib1g \
        libncurses6 \
        build-essential \
        libssl-dev \
        ruby \
        ruby-dev \
        docker.io \
        vim \
        git \
        wget \
        --no-install-recommends && \
    apt-get clean

RUN gem install bundler

ARG USER=android-agent
ARG USER_ID=1000
ARG GROUP_ID=1000
RUN useradd -m ${USER} --uid=${USER_ID} --non-unique || true
USER ${USER_ID}:${GROUP_ID}
WORKDIR /home/${USER}
ENV HOME=/home/${USER}

# Download Android cmdline-tools
RUN mkdir -p /home/${USER}/android-sdk/cmdline-tools && \
    wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip && \
    unzip -q cmdline-tools.zip && \
    mv cmdline-tools /home/${USER}/android-sdk/cmdline-tools/latest && \
    rm cmdline-tools.zip

# Download Android NDK
ENV ANDROID_NDK_HOME=/home/${USER}/android-ndk
ENV ANDROID_NDK_VERSION=r27b
RUN mkdir /home/${USER}/android-ndk-tmp && \
    cd /home/${USER}/android-ndk-tmp && \
    wget -q https://dl.google.com/android/repository/android-ndk-${ANDROID_NDK_VERSION}-linux.zip && \
    unzip -q android-ndk-${ANDROID_NDK_VERSION}-linux.zip && \
    mv ./android-ndk-${ANDROID_NDK_VERSION} ${ANDROID_NDK_HOME} && \
    rm -rf /home/${USER}/android-ndk-tmp

ENV ANDROID_HOME=/home/${USER}/android-sdk
ENV ANDROID_SDK=${ANDROID_HOME}
ENV PATH=${ANDROID_HOME}/cmdline-tools/latest/bin:${ANDROID_HOME}/platform-tools:${ANDROID_HOME}/emulator:${ANDROID_NDK_HOME}:${PATH}

# Accept licenses and install SDK components
ARG BUILD_TOOLS_VERSION=35.0.0
ARG PLATFORMS_VERSION=android-35
ARG ARCHITECTURE=x86_64

RUN yes | sdkmanager --licenses && \
    sdkmanager "platform-tools" "build-tools;${BUILD_TOOLS_VERSION}" "platforms;${PLATFORMS_VERSION}" \
    "system-images;${PLATFORMS_VERSION};default;${ARCHITECTURE}" \
    "extras;android;m2repository" "extras;google;m2repository"
